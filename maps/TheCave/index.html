<!doctype html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>CAVeViewer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="shortcut icon" href="/favicon.ico" />
	<link rel="stylesheet" href="../../style.css" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Raleway:300,400" rel="stylesheet" />
	<script defer type="module" src="../../src/stdpageheader.jsx"></script>
	<script>
		const glb_filepath = "/3d-assets/TheCave.compressed.glb";
		const start_pos = [.40724, .3168, 1.5933];
		const end_pos = [-.25, -.188, -1.0382];
		const look_at_vec = [-.404, -.30432, -1.6337];
		const showControls = false;
		const autoRotateModel = false;
		const playBarEnable = true;

		
		let userImageLink = "/images/buddyfallback.png";
        let time_start, end_time, bytesps;
		let periodic_progress_update = false;
		let firstload = true;

        // The size in bytes
        let downloadSize = 74360;
        let downloadImgSrc = new Image();

        downloadImgSrc.onload = function () {
            end_time = new Date().getTime();
            displaySpeed();
        };
        time_start = new Date().getTime();
        downloadImgSrc.src = userImageLink;


        function displaySpeed() {
            let timeDuration = (end_time - time_start) / 1000;
            bytesps = (downloadSize / timeDuration).toFixed(2);
			console.log("Download speed: %f", bytesps);
        }


		let intervalId = null; // Store the interval ID for clearing later
		let start_time = null;

		function fetchDataAndUpdateUI() {
			try {

				console.log("looped");
				console.log("periodic_progress_update: ", periodic_progress_update);

				if(periodic_progress_update)
				{
					if(firstload)
					{
						firstload = false;
						start_time = new Date().getTime();
						console.log("start_time: %f", start_time);
					}
					const totalBytes = 2451836;
					
					const curr_time = new Date().getTime();
					console.log("curr_time: %f", curr_time);
					console.log("start_time: %f", start_time);
					const time_diff = (curr_time - start_time)/1000;
					console.log("time_diff: %f", time_diff);

					const estBytesDownLoad = time_diff * bytesps;
					console.log("Estimated Bytes Downloaded: %f", estBytesDownLoad);

					const newProgress = Math.round(500 * estBytesDownLoad / totalBytes);
					console.log("Progress percent: %d", newProgress);
					
					let progress = newProgress > 95 ? 95 : newProgress;
					document.getElementById("progress-bar").style.width = progress + "%";
					document.getElementById("progress-bar").textContent = progress + "%";
				}


			} catch (error) {
				console.error('Error during periodic update:', error);
				// Optionally, stop the interval on error
				clearInterval(intervalId);
			}
		}

		intervalId = setInterval(fetchDataAndUpdateUI, 2000);
	</script>
	<script defer type="module" src="../../src/app.js"></script>
</head>

<body>
	<div id="headerroot"></div>
	<div id="app-content"></div>
</body>